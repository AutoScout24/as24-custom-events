language: node_js
node_js:
  - stable
cache:
  yarn: true
  directories:
    - node_modules
notifications:
  email: false
before_install:
  - set -e
  # Add ssh key w/ write permission for `as24-custom-events` repo
  - openssl aes-256-cbc -K $encrypted_ab46abe2afd1_key -iv $encrypted_ab46abe2afd1_iv -in travis_ci_rsa.enc -out ./travis_ci_rsa -d
  - chmod 600 travis_ci_rsa
  - eval `ssh-agent -s`
  - ssh-add travis_ci_rsa
install:
  - yarn install
  - yarn global add codecov
script:
  - yarn run test
  - yarn run build
after_success:
  - codecov
  - |
    # Check if we need to do SEMVER bump based on commit's parent PR labels
    # - only run for master branch we don't want to release PRs and other branches
    # - only run on non-tagged releases, this will bump the version, tag, commit & push back to github
    if [ "$TRAVIS_PULL_REQUEST" == "false" ] && [ -z "$TRAVIS_TAG" ] && [ "$TRAVIS_BRANCH" == "master" ]; then 
      SEMVER_BUMP=$(./semver_from_pr_labels.sh $TRAVIS_COMMIT 2>/dev/null)      
      if [[ ! -z "$SEMVER_BUMP" ]]; then
        echo "Bumping package version for $SEMVER_BUMP release and pushing tag to github"
        git checkout master # switch to master branch (which is the same as the current commit), so we are not in DETACHED mode
        yarn version --new-version $SEMVER_BUMP
        git remote set-url origin git@github.com:Scout24/as24-custom-events.git # use ssh instead of https
        git push origin master --follow-tags
      else 
        echo "No sematic version release label found on PR, tagging skipped."        
      fi
    fi
deploy:
  - provider: npm
    email: '#AS24-Web-Experience-Team-ds@scout24.com'
    skip_cleanup: true
    api_key:
      secure: WjCvHKjnn6VvQV76TY45hoRNJQy4lp0tjaPB1nqUK7J7wJQlSwoienYRf0iiTiXkynQ+qnotQPO4Zkzx9ViLAU84+RtBIsB0sjFlNznlogjDYCSK89yQN0CPcPpUw8ledNvESh2LMQZMahVkxwpUZRIR4AbbVTZJIWkxFCeVYL8IqOqnk2JLQz0vCmcRq/dPXWWEZIk11RjihdlG/5WXFjYL9iYIYQYGz3KxEr2Ma1Ym/FVTxMP/re5yXyw6qnr7bZEaDgr1aMJxovAYGl854h02sp5v7zlm3J09mOmO+hibpVFKVwQAByqItOYL+bZkkjFGRQhginWE1EJgc/qbxFry0FpMeLqhW62MqEOWruq7uuey7x4CLywcvFIOhiG4ryOlN4m5jOVMfZ5c1qhKdO8HHiKmVHzdvwA3g08lXByzeG0jidOEemRJAegmvZ7XrwIYpMYgLg1Cs4GjVH7XigubKv8KSz2LsKfvMY0JKlnePRujhmD4/RqAwBpWmc2cKdsPvvVXrlmKOloLnkPSPNKauqIUKPW/3naxd60rnTIhuMOFtUoH6pwcFDerSGrH18AB09g1YCoI8k9XXgFxkhIj5XpVh4HIfAR45hRUiMMgFppoBkTQINcXciqU7u36TJHx0k4Ojm5bTbXOr+2UI7P+KT+NZMV6uvV4YiECbzQ=
    on:
      tags: true
      repo: Scout24/as24-custom-events
      branch: master
  - provider: releases
    skip_cleanup: true
    file_glob: true
    file:
      - './dist/**/*'
    on:
      tags: true
      repo: Scout24/as24-custom-events
      branch: master
